
module.exports = "@export qtek.deferred.output.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 world: WORLD;\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n\nuniform vec2 uvRepeat;\nuniform vec2 uvOffset;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 skinMatrix[JOINT_COUNT] : SKIN_MATRIX;\n#endif\n\nvarying vec2 v_Texcoord;\n\nvarying vec4 v_ProjPos;\n\nvarying vec3 v_WorldPos;\n\nvoid main()\n{\n\n    vec3 skinnedPosition = position;\n\n#ifdef SKINNING\n\n    @import qtek.chunk.skin_matrix\n\n    skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n#endif\n\n    gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n\n    v_WorldPos = (world * vec4(skinnedPosition, 1.0)).xyz;\n\n    v_ProjPos = gl_Position;\n\n    v_Texcoord = texcoord * uvRepeat + uvOffset;\n}\n@end\n\n@export qtek.deferred.output.fragment\n\nuniform sampler2D diffuseMap;\n\nuniform sampler2D lightAccumTex;\nuniform sampler2D gBufferTex;\n\nuniform vec3 color;\nuniform vec3 specularColor;\nuniform vec3 emission;\n\nuniform vec3 eyePosition;\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_WorldPos;\nvarying vec4 v_ProjPos;\n\nconst vec3 LUM = vec3(0.2125, 0.7154, 0.0721);\n\n// Fresnel\nvec3 F_Schlick(float ndv, vec3 spec) {\n    return spec + (1.0 - spec) * pow(1.0 - ndv, 5.0);\n}\n\nvoid main()\n{\n    vec2 uv = (v_ProjPos.xy / v_ProjPos.w + 1.0) * 0.5;\n\n    vec3 V = normalize(eyePosition - v_WorldPos);\n\n    vec3 albedo = color;\n#ifdef diffuseMap\n    albedo *= texture2D(diffuseMap, v_Texcoord);\n#endif\n\n    vec4 diffSpec = texture2D(lightAccumTex, uv);\n\n    vec3 N = texture2D(gBufferTex, uv).xyz * 2.0 - 1.0;\n\n    vec3 diffTerm = diffSpec.rgb;\n    // PENDING\n    vec3 specTerm = diffTerm * diffSpec.a / (dot(LUM, diffTerm) + 0.001);\n    vec3 fresnelTerm = F_Schlick(clamp(dot(N, V), 0.0, 1.0), specularColor);\n\n    gl_FragColor.rgb = albedo * diffTerm + fresnelTerm * specTerm + emission;\n    gl_FragColor.a = 1.0;\n}\n@end\n\n";
